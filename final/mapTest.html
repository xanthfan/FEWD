<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { width:100% ; height: 100% }
    </style>

    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMLGETiyd_eYo65xHXPeGagUuroCNkbzM&sensor=false">
    </script>
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js">
    </script>

    <script src="data/map.jsonp"></script>

    <script type="text/javascript">

    var mapLatLng, mapZoom, happyLatLng, sadLatLng;


//======================================Helper Functions======================================


    //Creates the map and the markers. Is called every time the map HTML page is revisited in its iframe.
    //The if this is a subsequent reloading of the map page, then the last position and zoom of the map and the position of the markers are recalled from objects stored with the SessionStorage variable. 
    function initialize() {

    // Creating the latitude/longitude object for each map marker
      happyLatLng = initLatLng("happy", 1);
      sadLatLng = initLatLng("sad", 2);

      var mapOptions = {
        center: mapLatLng,
        zoom: mapZoom,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };

      var map = new google.maps.Map(document.getElementById("map-canvas"),
          mapOptions);

       var marker = new google.maps.Marker({
          position: happyLatLng,
          map: map,
          draggable:true,
          title:"Happy!",
          icon: "images/happy.png"
        });

        var marker2 = new google.maps.Marker({
          position: sadLatLng,
          map: map,
          draggable:true,
          title:"Sad.",
          icon: "images/sad.png"
        });

        // Record the position of the map if it gets shifted by the user
        google.maps.event.addListener(map,"dragend",function(evt){
            var xyPos = map.getCenter();
            var MapLatLng = {
              lat : xyPos.lat(),
              lng : xyPos.lng()
            };
            sessionStorage.mapLatLng = JSON.stringify(MapLatLng);
        })

        google.maps.event.addListener(map,"zoom_changed",function(evt){
            sessionStorage.mapZoom = map.getZoom(); 
        })

        function addMarkerListener(marker, sessionStorageMarker){
          google.maps.event.addListener(marker, "dragend", function(evt){ 
            var xyPos = marker.getPosition();
            var MarkerLatLng = {
              lat : xyPos.lat(),
              lng : xyPos.lng()
            };
            // sessionStorage[sessionStorageLat] = xyPos.lat();
            // sessionStorage[sessionStorageLng] = xyPos.lng();
            sessionStorage[sessionStorageMarker] = JSON.stringify(MarkerLatLng);
          })
        }

        addMarkerListener(marker, "happy");

        addMarkerListener(marker2, "sad");
    }
    // End initialize()


    function initLatLng(whichMarker, index){
      if (!sessionStorage[whichMarker]){
        markerLatLng = new google.maps.LatLng(jsonstr[index][whichMarker].x, jsonstr[index][whichMarker].y);
        return markerLatLng;
      } else {
        var coords = JSON.parse(sessionStorage[whichMarker]);
        markerLatLng = new google.maps.LatLng(coords.lat, coords.lng);
        return markerLatLng;
      }
    }


//=====================================Main Body======================================

    if (!sessionStorage.mapLatLng){
      mapLatLng = new google.maps.LatLng(jsonstr[0].HK.x, jsonstr[0].HK.y);
    } else {
      var coords = JSON.parse(sessionStorage.mapLatLng);
      mapLatLng = new google.maps.LatLng(coords.lat, coords.lng);
    }

    if (!sessionStorage.mapZoom){
      mapZoom = jsonstr[0].HK.zoom;      
    } else {
      mapZoom = Number(sessionStorage.mapZoom);
    }
    
    // Call initialize() to create the map after the page loads
    google.maps.event.addDomListener(window, 'load', initialize);



    </script>
  </head>
  <body>
    <div id="map-canvas">a</div>
  </body>
</html>